sudo: true
language: java
jdk: oraclejdk8
dist: trusty

services:
  - docker

env:
  global:
     - secure: "encrypted-sonar-token"
     - secure: "encrypted-dockerhub-username"
     - secure: "encrypted-dockerhub-password"
     - secure: "encrypted-heroku-api-key"
addons:
  sonarcloud:
    organization: "hichmen-github"
    token:
      secure: $SONAR_TOKEN

#before_install:
#  â€“ chmod +x mvnw
install:
  #Preparation
  - mvn install -DskipTests=true -Dmaven.javadoc.skip=true -B -V

script:
  #Code are clean?
#  - chmod +x ./mvnw clean org.jacoco:jacoco-maven-plugin:prepare-agent package sonar:sonar
#  - chmod +x mvn sonar:sonar \
#    -Dsonar.projectKey=hichMEN_spark-microservices \
#    -Dsonar.organization=hichmen-github \
#    -Dsonar.host.url=https://sonarcloud.io \
#    -Dsonar.login=df67bcc10584f3351440da7c9433c5d2927e669d
  #unit tests pass
  #integration tests pass
  #run
  - mvn spring-boot:run
after_success:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  - export IMAGE_NAME=spark-microservices
  - docker build -t $IMAGE_NAME:$COMMIT .
  - docker tag $IMAGE_NAME:$COMMIT $IMAGE_NAME:$TAG
  - docker push $IMAGE_NAME

deploy:
  provider: heroku
  api_key: $HEROKU_API_KEY
  app: spark-microservices